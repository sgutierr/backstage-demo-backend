{"version":3,"file":"index.cjs.js","sources":["../src/collators/DefaultTechDocsCollatorFactory.ts"],"sourcesContent":["/*\n * Copyright 2022 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  PluginEndpointDiscovery,\n  TokenManager,\n} from '@backstage/backend-common';\nimport {\n  CatalogApi,\n  CatalogClient,\n  CATALOG_FILTER_EXISTS,\n} from '@backstage/catalog-client';\nimport {\n  Entity,\n  parseEntityRef,\n  RELATION_OWNED_BY,\n  stringifyEntityRef,\n} from '@backstage/catalog-model';\nimport { Config } from '@backstage/config';\nimport { catalogEntityReadPermission } from '@backstage/plugin-catalog-common/alpha';\nimport { Permission } from '@backstage/plugin-permission-common';\nimport { DocumentCollatorFactory } from '@backstage/plugin-search-common';\nimport { TechDocsDocument } from '@backstage/plugin-techdocs-node';\nimport unescape from 'lodash/unescape';\nimport fetch from 'node-fetch';\nimport pLimit from 'p-limit';\nimport { Readable } from 'stream';\nimport { Logger } from 'winston';\n\ninterface MkSearchIndexDoc {\n  title: string;\n  text: string;\n  location: string;\n}\n\n/**\n * Options to configure the TechDocs collator factory\n *\n * @public\n */\nexport type TechDocsCollatorFactoryOptions = {\n  discovery: PluginEndpointDiscovery;\n  logger: Logger;\n  tokenManager: TokenManager;\n  locationTemplate?: string;\n  catalogClient?: CatalogApi;\n  parallelismLimit?: number;\n  legacyPathCasing?: boolean;\n};\n\ntype EntityInfo = {\n  name: string;\n  namespace: string;\n  kind: string;\n};\n\n/**\n * A search collator factory responsible for gathering and transforming\n * TechDocs documents.\n *\n * @public\n */\nexport class DefaultTechDocsCollatorFactory implements DocumentCollatorFactory {\n  public readonly type: string = 'techdocs';\n  public readonly visibilityPermission: Permission =\n    catalogEntityReadPermission;\n\n  private discovery: PluginEndpointDiscovery;\n  private locationTemplate: string;\n  private readonly logger: Logger;\n  private readonly catalogClient: CatalogApi;\n  private readonly tokenManager: TokenManager;\n  private readonly parallelismLimit: number;\n  private readonly legacyPathCasing: boolean;\n\n  private constructor(options: TechDocsCollatorFactoryOptions) {\n    this.discovery = options.discovery;\n    this.locationTemplate =\n      options.locationTemplate || '/docs/:namespace/:kind/:name/:path';\n    this.logger = options.logger.child({ documentType: this.type });\n    this.catalogClient =\n      options.catalogClient ||\n      new CatalogClient({ discoveryApi: options.discovery });\n    this.parallelismLimit = options.parallelismLimit ?? 10;\n    this.legacyPathCasing = options.legacyPathCasing ?? false;\n    this.tokenManager = options.tokenManager;\n  }\n\n  static fromConfig(config: Config, options: TechDocsCollatorFactoryOptions) {\n    const legacyPathCasing =\n      config.getOptionalBoolean(\n        'techdocs.legacyUseCaseSensitiveTripletPaths',\n      ) || false;\n    return new DefaultTechDocsCollatorFactory({ ...options, legacyPathCasing });\n  }\n\n  async getCollator(): Promise<Readable> {\n    return Readable.from(this.execute());\n  }\n\n  private async *execute(): AsyncGenerator<TechDocsDocument, void, undefined> {\n    const limit = pLimit(this.parallelismLimit);\n    const techDocsBaseUrl = await this.discovery.getBaseUrl('techdocs');\n    const { token } = await this.tokenManager.getToken();\n    let entitiesRetrieved = 0;\n    let moreEntitiesToGet = true;\n\n    // Offset/limit pagination is used on the Catalog Client in order to\n    // limit (and allow some control over) memory used by the search backend\n    // at index-time. The batchSize is calculated as a factor of the given\n    // parallelism limit to simplify configuration.\n    const batchSize = this.parallelismLimit * 50;\n    while (moreEntitiesToGet) {\n      const entities = (\n        await this.catalogClient.getEntities(\n          {\n            filter: {\n              'metadata.annotations.backstage.io/techdocs-ref':\n                CATALOG_FILTER_EXISTS,\n            },\n            fields: [\n              'kind',\n              'namespace',\n              'metadata.annotations',\n              'metadata.name',\n              'metadata.title',\n              'metadata.namespace',\n              'spec.type',\n              'spec.lifecycle',\n              'relations',\n            ],\n            limit: batchSize,\n            offset: entitiesRetrieved,\n          },\n          { token },\n        )\n      ).items;\n\n      // Control looping through entity batches.\n      moreEntitiesToGet = entities.length === batchSize;\n      entitiesRetrieved += entities.length;\n\n      const docPromises = entities\n        .filter(it => it.metadata?.annotations?.['backstage.io/techdocs-ref'])\n        .map((entity: Entity) =>\n          limit(async (): Promise<TechDocsDocument[]> => {\n            const entityInfo =\n              DefaultTechDocsCollatorFactory.handleEntityInfoCasing(\n                this.legacyPathCasing,\n                {\n                  kind: entity.kind,\n                  namespace: entity.metadata.namespace || 'default',\n                  name: entity.metadata.name,\n                },\n              );\n\n            try {\n              const searchIndexResponse = await fetch(\n                DefaultTechDocsCollatorFactory.constructDocsIndexUrl(\n                  techDocsBaseUrl,\n                  entityInfo,\n                ),\n                {\n                  headers: {\n                    Authorization: `Bearer ${token}`,\n                  },\n                },\n              );\n\n              // todo(@backstage/techdocs-core): remove Promise.race() when node-fetch is 3.x+\n              // workaround for fetch().json() hanging in node-fetch@2.x.x, fixed in 3.x.x\n              // https://github.com/node-fetch/node-fetch/issues/665\n              const searchIndex = await Promise.race([\n                searchIndexResponse.json(),\n                new Promise((_resolve, reject) => {\n                  setTimeout(() => {\n                    reject('Could not parse JSON in 5 seconds.');\n                  }, 5000);\n                }),\n              ]);\n\n              return searchIndex.docs.map((doc: MkSearchIndexDoc) => ({\n                title: unescape(doc.title),\n                text: unescape(doc.text || ''),\n                location: this.applyArgsToFormat(\n                  this.locationTemplate || '/docs/:namespace/:kind/:name/:path',\n                  {\n                    ...entityInfo,\n                    path: doc.location,\n                  },\n                ),\n                path: doc.location,\n                ...entityInfo,\n                entityTitle: entity.metadata.title,\n                componentType: entity.spec?.type?.toString() || 'other',\n                lifecycle: (entity.spec?.lifecycle as string) || '',\n                owner: getSimpleEntityOwnerString(entity),\n                authorization: {\n                  resourceRef: stringifyEntityRef(entity),\n                },\n              }));\n            } catch (e) {\n              this.logger.debug(\n                `Failed to retrieve tech docs search index for entity ${entityInfo.namespace}/${entityInfo.kind}/${entityInfo.name}`,\n                e,\n              );\n              return [];\n            }\n          }),\n        );\n      yield* (await Promise.all(docPromises)).flat();\n    }\n  }\n\n  private applyArgsToFormat(\n    format: string,\n    args: Record<string, string>,\n  ): string {\n    let formatted = format;\n    for (const [key, value] of Object.entries(args)) {\n      formatted = formatted.replace(`:${key}`, value);\n    }\n    return formatted;\n  }\n\n  private static constructDocsIndexUrl(\n    techDocsBaseUrl: string,\n    entityInfo: { kind: string; namespace: string; name: string },\n  ) {\n    return `${techDocsBaseUrl}/static/docs/${entityInfo.namespace}/${entityInfo.kind}/${entityInfo.name}/search/search_index.json`;\n  }\n\n  private static handleEntityInfoCasing(\n    legacyPaths: boolean,\n    entityInfo: EntityInfo,\n  ): EntityInfo {\n    return legacyPaths\n      ? entityInfo\n      : Object.entries(entityInfo).reduce((acc, [key, value]) => {\n          return { ...acc, [key]: value.toLocaleLowerCase('en-US') };\n        }, {} as EntityInfo);\n  }\n}\n\nfunction getSimpleEntityOwnerString(entity: Entity): string {\n  if (entity.relations) {\n    const owner = entity.relations.find(r => r.type === RELATION_OWNED_BY);\n    if (owner) {\n      const { name } = parseEntityRef(owner.targetRef);\n      return name;\n    }\n  }\n  return '';\n}\n"],"names":["catalogEntityReadPermission","CatalogClient","Readable","pLimit","CATALOG_FILTER_EXISTS","fetch","unescape","stringifyEntityRef","RELATION_OWNED_BY","parseEntityRef"],"mappings":"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"}